# App Settings File Guide

## Configuration Guide

The appsettings.json example below is configured to poll the following endpoints and send the respective responses to the configured MQTT broker.

## Supported Customizations

### Relative Urls Support the Following Macros

1. ```{yyyy-mm-dd}``` will replace it with the current date, example:

   ```/api/breed/hound/list/{yyyy-mm-dd}``` -> ```/api/breed/hound/list/2024-10-09```
2. ```{yyyy-mm}``` will replace it with the current date, example:

   ```/api/breed/hound/{yyyy-mm}/list``` -> ```/api/breed/hound/2024-10/list```

### MQTT Topic Name Generation and Customization

MQTT topic name is auto generated by the application for each relative endpoint, as an example:

Given the following (from example config below):

1. Base Topic: `azure-iot-operations/data/`
2. Endpoint Url: `https://dog.ceo`
3. Relative Endpoint Url: `/api/breed/hound/list`

Steps used to generate the MQTT topic are:

1. Acquire unique source Id of the source where data is read, http in this instance will have a source Id as a fully qualified url i.e. "Endpoint Url + Relative Endpoint Url" (`https://dog.ceo/api/breed/hound/list`).
2. Calculate SHA256 hash of source Id and then convert it to hexadecimal string to avoid special chars i.e. `8bed43594758bdc7252817cb47391a06bc4a065ab78b1e63bfe6349439430165`. Adding SHA256 of unique source Id makes each MQTT topic unique which may not be the case otherwise.
3. Replace characters and strings from config section `TopicStringReplacements` in source Id i.e. `https-dog_ceo/api/breed/hound/list`.
4. Concatenate strings using the formula `<Base Topic> + <SHA256 Hash from Step 2> + <Source Id from Step 3>` i.e. `azure-iot-operations/data/8bed43594758bdc7252817cb47391a06bc4a065ab78b1e63bfe6349439430165/https-dog_ceo/api/breed/bulldog/list`

> **Note:** AIO's current version (v0.8.32) has a bug in UI which does not allow all valid MQTT topic name characters e.g. dot(.), colon (:) to be configured. `TopicStringReplacements` section in the config below allows you to replace these characters/strings in the default generated (as above) topic name.

## Example appsettings.json for AIO MQTT broker

```json
{
 "Http": {
    "Endpoints": [
      {
        "Url": "https://dog.ceo",
        "TimeOutInSeconds": 5,
        "RelativeEndpoints": [
          {
            "Url": "/api/breed/hound/list",
            "PollingInternalInMilliseconds": 2000
          },
          {
            "Url": "/api/breed/greyhound/list",
            "PollingInternalInMilliseconds": 2000
          }
        ]
      },
      {
        "Url": "https://dog.ceo",
        "TimeOutInSeconds": 5,
        "RelativeEndpoints": [
          {
            "Url": "/api/breed/bulldog/list",
            "PollingInternalInMilliseconds": 2000
          },
          {
            "Url": "/api/breed/retriever/list",
            "PollingInternalInMilliseconds": 2000
          }
        ]
      }
    ]
  },
  "Mqtt": {
    "Host": "aio-broker",
    "Port": 18883,
    "ClientId": "Http.Mqtt.Connector.Svc",
    "UseTls": true,
    "SatFilePath": "/var/run/secrets/tokens/broker-sat",
    "CaFilePath": "/var/run/certs/ca.crt",
    "BaseTopic": "azure-iot-operations/data/",
    "TopicStringReplacements": [
      {
        "OldValue": "#",
        "NewValue": "_"
      },
      {
        "OldValue": "+",
        "NewValue": "_"
      },
      {
        "OldValue": ".",
        "NewValue": "_"
      },
      {
        "OldValue": "{",
        "NewValue": "_"
      },
      {
        "OldValue": "}",
        "NewValue": "_"
      },
      {
        "OldValue": ":",
        "NewValue": "-"
      },
      { 
        "OldValue": "//",
        "NewValue": ""
      }
    ]
  },
  "Logging": {
    "LogLevel": {
      "Default": "Trace",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  }
}
```

## Example appsettings.json for non AIO MQTT broker

```json
{
 "Http": {
    "Endpoints": [
      {
        "Url": "https://dog.ceo",
        "TimeOutInSeconds": 5,
        "RelativeEndpoints": [
          {
            "Url": "/api/breed/hound/list",
            "PollingInternalInMilliseconds": 2000
          },
          {
            "Url": "/api/breed/greyhound/list",
            "PollingInternalInMilliseconds": 2000
          }
        ]
      },
      {
        "Url": "https://dog.ceo",
        "TimeOutInSeconds": 5,
        "RelativeEndpoints": [
          {
            "Url": "/api/breed/bulldog/list",
            "PollingInternalInMilliseconds": 2000
          },
          {
            "Url": "/api/breed/retriever/list",
            "PollingInternalInMilliseconds": 2000
          }
        ]
      }
    ]
  },
  "Mqtt": {
    "Host": "broker.emqx.io",
    "Port": 1883,
    "ClientId": "Http.Mqtt.Connector.Svc",
    "UseTls": false,
    "Username": "",
    "Password": "",
    "BaseTopic": "azure-iot-operations/data/",
    "TopicStringReplacements": [
      {
        "OldValue": "#",
        "NewValue": "_"
      },
      {
        "OldValue": "+",
        "NewValue": "_"
      },
      {
        "OldValue": ".",
        "NewValue": "_"
      },
      {
        "OldValue": "{",
        "NewValue": "_"
      },
      {
        "OldValue": "}",
        "NewValue": "_"
      },
      {
        "OldValue": ":",
        "NewValue": "-"
      },
      { 
        "OldValue": "//",
        "NewValue": ""
      }
    ]
  },
  "Logging": {
    "LogLevel": {
      "Default": "Trace",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  }
}
```
